<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Home</title>
    <th:block th:replace="/layout/head :: head" />
</head>
<body>
<div class="container">
    <th:block th:replace="/layout/menu :: menu" />
    <div class="content">

    </div>
    <th:block th:replace="/layout/introduce :: introduce" />
    <th:block th:replace="/layout/footer :: footer" />
</div>
<th:block th:replace="/layout/temp_block_product :: temp_block_product" />
<th:block th:replace="/layout/temp_block_product_info :: temp_block_product_info" />
<th:block th:replace="/layout/cart_modal :: cart_modal" />
<th:block th:replace="/layout/product_info :: product_info" />
<th:block th:replace="/layout/tem_block_product_cart :: temp_block_product_cart" />
<th:block th:replace="/layout/script :: script" />
<script>
    let page = {
        url : {
            getAllProduct : App.BASER_URL + "products/",
            doAddCart : App.BASER_URL + "carts/add",
            getAllCartItem : App.BASER_URL + "carts/",
            doReduceCart : App.BASER_URL + "carts/reduce",
            doIncreaseCart : App.BASER_URL + "carts/increase",
            doRemoveCartItem : App.BASER_URL + "carts/remove-cart-item"
        },
        elements : {
            locationRegion : {}
        },
        loadData : {},
        commands : {},
        dialogs : {
            elements: {},
            commands: {}
        },
        initializeControllEvents : {}
    }

    page.elements.btnShowCartInfo = $('.show_cart');
    page.elements.cartInfoContent = $('.cart--info--content');
    page.elements.cartInfoGrandTotal = $('.cart--info--total span');
    page.dialogs.elements.modalCart = $('.cart');
    page.dialogs.elements.modalProductInfo = $('.show--info--product');

    let product = new Product();

    let cart = new Cart();

    let user = new User();

    let cartItem = new CartItem();

    let tempBlockProduct = $.validator.format($.trim($('#tempBlockProduct').val().toString()));

    let tempBlockProductInfo = $.validator.format($.trim($('#tempBlockProductInfo').val().toString()));

    let tempBlockProductCart = $.validator.format($.trim($('#tempBlockProductCart').val().toString()));

    function addBlockProductInfo() {
        $('.show--info--product').html("");
        $('.show--info--product').prepend($(tempBlockProductInfo(product.urlImage,product.title,product.price,product.id)));
    }

    function addBlockProductCart() {
        $('.cart--info--content').prepend($(tempBlockProductCart(cartItem.product.urlImage,cartItem.title,cartItem.price,cartItem.quantity,cartItem.product.id)));
    }

    function addBlockProduct() {
        $('.content').prepend($(tempBlockProduct(product.urlImage,product.id,product.id,product.title,product.price,product.id)));
    }

    page.loadData.getAllProduct = () =>{
        $.ajax({
            "headers": {
                "accept": "application/json",
                "content-type": "application/json"
            },
            "type": "GET",
            "url": page.url.getAllProduct
        })
        .done((data) => {
            $('.content').html("");
            $.each(data, (i, item) => {
                product = item;
                product.price = App.formatNumberSpace(product.price);
                addBlockProduct();
            });
            page.commands.handleClickShowInfo();
        })
        .fail((jqXHR) => {
            console.log(jqXHR)
        })
    }

    page.loadData.getProduct = () => {
        $('.content--product--top h4').on('click',function (){
            let productId = $(this).data("id");

            $.ajax({
                "headers": {
                    "accept": "application/json",
                    "content-type": "application/json"
                },
                "type": "GET",
                "url": page.url.getAllProduct + productId,
            })
            .done((data) => {
                product = data;
                addBlockProductInfo();
                page.commands.handleClickShowInfo();
            })
            .fail((jqXHR) => {

            })

        })
    }

    page.commands.handleClickShowInfo = ()  => {

        handleClickQuantity();
        $('#icon_close_cart').on('click',function() {
            $('.cart').removeClass('show').addClass('hide');
        })
        $('.content--product--top h4').on('click',function(){
            $('.show--info--product').removeClass('hide').addClass('show');
        })
        $('#btnClose').on('click',function() {
            $('.show--info--product').removeClass('show').addClass('hide');
        })
        page.loadData.getProduct();
        page.commands.doAddCart();
        page.commands.showCartInfo();
        page.commands.doAddCartProductInfo();
        page.commands.handleClickQuantityProductInfo();
    }

    function handleClickQuantity() {
        page.commands.reduce();
        page.commands.increase();
    }

    $(()=>{
        page.loadData.getAllProduct();
    })

    page.commands.doAddCart = () => {
        $('.add--cart').on('click',function (){
            let userId = $('.header--right a span').attr('id');
            let productId = $(this).data("id");
            let quantity = 1;
            cart.userId = userId;
            cart.productId = productId;
            cart.quantity = quantity;

            $.ajax({
                "headers": {
                    "accept": "application/json",
                    "content-type": "application/json"
                },
                "type": "POST",
                "url": page.url.doAddCart,
                "data": JSON.stringify(cart)
            })
            .done((data) => {
                if (data.successFirst){
                    App.IziToast.showSuccessAlert(data.successFirst);
                }
                App.IziToast.showSuccessAlert(data.success);
            })
            .fail((jqXHR) => {
                if (jqXHR.status === 401)  {
                   App.IziToast.showErrorAlert("Vui Lòng Đăng Nhập Để Mua Hàng");
                }else {
                    if(jqXHR.responseJSON.message){
                        let msg = jqXHR.responseJSON.message;
                        App.IziToast.showErrorAlert(msg);
                    }else if(jqXHR.responseJSON){
                        $.each(jqXHR.responseJSON,(key,item) =>{
                            App.IziToast.showErrorAlert(item);
                        })
                    }
                }
            })
        })
    }
    page.commands.showCartInfo = () => {
        page.elements.btnShowCartInfo.on('click',function (){
            let userId = page.elements.btnShowCartInfo.attr("id");
            $.ajax({
                "headers": {
                    "accept": "application/json",
                    "content-type": "application/json"
                },
                "type": "GET",
                "url": page.url.getAllCartItem + userId,
            })
            .done((data) => {
                console.log(data);
                if (data.noCart){
                    App.IziToast.showSuccessAlert(data.noCart);
                }else {
                    page.elements.cartInfoContent.html("");
                    page.elements.cartInfoGrandTotal.html("");
                    let grandTotal = 0;
                    $.each(data, (i, item) => {
                        cartItem = item;
                        cartItem.price = App.formatNumberSpace(cartItem.price);
                        grandTotal = App.formatNumberSpace(cartItem.cart.grandTotal);
                        addBlockProductCart();
                    });
                    page.elements.cartInfoGrandTotal.text(`${grandTotal} đ`);
                    handleClickQuantity();
                    page.commands.removeProductByCart();
                    page.dialogs.elements.modalCart.removeClass('hide').addClass('show');
                }
            })
            .fail((jqXHR) => {
                if (jqXHR.status === 401)  {
                    App.IziToast.showErrorAlert("Vui Lòng Đăng Nhập Để Xem Giỏ Hàng Của Bạn");
                }else {

                }
            })
        })
    }
    page.commands.reduce = () => {
        $('.quantity-up').on("click",function (){
            let cartItemReduce = new CartItem();
            let productId = $(this).data("id");
            let userId = $('.header--right a span').attr('id');
            let quantity = $(`.input_${productId}`).val();
            let reduceValue = Number(quantity) + 1;
            let cart = new Cart();

            if ($.isNumeric(quantity)) {
                cart.userId = userId;
                cart.productId = productId;
                cart.quantity = 1;
                $.ajax({
                    "headers": {
                        "accept": "application/json",
                        "content-type": "application/json"
                    },
                    "type": "POST",
                    "url": page.url.doReduceCart,
                    "data": JSON.stringify(cart),
                })
                .done((data) => {
                    cartItemReduce = data.cartItem;
                    $(`.input_${productId}`).val(reduceValue);
                    page.elements.cartInfoGrandTotal.text(`${cartItemReduce.cart.grandTotal} đ`);
                    App.IziToast.showSuccessAlert(data.success);
                })
                .fail((jqXHR) => {
                    if (jqXHR.status === 401)  {
                        App.IziToast.showErrorAlert("Vui Lòng Đăng Nhập Để Xem Giỏ Hàng Của Bạn");
                    }else {

                    }
                })
            }
        })
    }
    page.commands.increase = () => {
        $('.quantity-down').on('click',function (){
            let cartItemIncrease = new CartItem();
            let productId = $(this).data("id");
            let userId = $('.header--right a span').attr('id');
            let quantity = $(`.input_${productId}`).val();
            let reduceValue = Number(quantity) - 1;
            let cart = new Cart();

            if ($.isNumeric(quantity)) {
                cart.userId = userId;
                cart.productId = productId;
                cart.quantity = 1;
                $.ajax({
                    "headers": {
                        "accept": "application/json",
                        "content-type": "application/json"
                    },
                    "type": "POST",
                    "url": page.url.doIncreaseCart,
                    "data": JSON.stringify(cart),
                })
                .done((data) => {
                    cartItemIncrease = data.cartItem;
                    $(`.input_${productId}`).val(reduceValue);
                    page.elements.cartInfoGrandTotal.text(`${cartItemIncrease.cart.grandTotal} đ`);
                    App.IziToast.showSuccessAlert(data.success);
                })
                .fail((jqXHR) => {
                    if (jqXHR.status === 401)  {
                        App.IziToast.showErrorAlert("Vui Lòng Đăng Nhập Để Xem Giỏ Hàng Của Bạn");
                    }else {
                        if(jqXHR.responseJSON.message){
                            let msg = jqXHR.responseJSON.message;
                            App.IziToast.showErrorAlert(msg);
                        }else if(jqXHR.responseJSON){
                            $.each(jqXHR.responseJSON,(key,item) =>{
                                App.IziToast.showErrorAlert(item);
                            })
                        }
                    }
                })
            }
        })
    }
    page.commands.doAddCartProductInfo = () => {
        $('.show--info--product--content--product--bottom a').on('click',function (){
            let userId = $('.header--right a span').attr('id');
            let productId = $(this).data("id");
            let quantity = $(`.input_quantity_${productId}`).val();
            cart.userId = userId;
            cart.productId = productId;
            cart.quantity = quantity;

            $.ajax({
                "headers": {
                    "accept": "application/json",
                    "content-type": "application/json"
                },
                "type": "POST",
                "url": page.url.doAddCart,
                "data": JSON.stringify(cart)
            })
            .done((data) => {
                if (data.successFirst){
                    App.IziToast.showSuccessAlert(data.successFirst);
                }
                App.IziToast.showSuccessAlert(data.success);
                $('.show--info--product').removeClass('show').addClass('hide');
            })
            .fail((jqXHR) => {
                if (jqXHR.status === 401)  {
                    App.IziToast.showErrorAlert("Vui Lòng Đăng Nhập Để Mua Hàng");
                }else {
                    if(jqXHR.responseJSON.message){
                        let msg = jqXHR.responseJSON.message;
                        App.IziToast.showErrorAlert(msg);
                    }else if(jqXHR.responseJSON){
                        $.each(jqXHR.responseJSON,(key,item) =>{
                            App.IziToast.showErrorAlert(item);
                        })
                    }
                }
            })
        })
    }

    page.commands.handleClickQuantityProductInfo = () => {
        $('.quantity--product--info .quantity-up_pro').on("click",function (){
            let productId = $(this).data("id");
            let quantity = $(`.input_quantity_${productId}`).val();

            if ($.isNumeric(quantity)) {
                let quantityChange = Number(quantity) + 1;
                $(`.input_quantity_${productId}`).val(quantityChange);
            }else {
                $(`.input_quantity_${productId}`).val("1");
            }
        })
        $('.quantity--product--info .quantity-down_pro').on("click",function (){
            let productId = $(this).data("id");
            let quantity = $(`.input_quantity_${productId}`).val();

            if ($.isNumeric(quantity) && Number(quantity) > 1) {
                let quantityChange = Number(quantity) - 1;
                $(`.input_quantity_${productId}`).val(quantityChange);
            }else{
                $(`.input_quantity_${productId}`).val("1");
            }
        })
    }

    page.commands.removeProductByCart = () => {
        $('.cart--info--content--product a').on("click",function (){
            let productId = $(this).data("id");
            let userId = $('.header--right a span').attr('id');

            cart.userId = userId;
            cart.productId = productId;
            cart.quantity = 0;

            $.ajax({
                "headers": {
                    "accept": "application/json",
                    "content-type": "application/json"
                },
                "type": "POST",
                "url": page.url.doRemoveCartItem,
                "data": JSON.stringify(cart),
            })
            .done((data) => {
                $(`.cart--product--${productId}`).remove();
                page.elements.cartInfoGrandTotal.text(`${data.cartInfo.grandTotal} đ`);
                App.IziToast.showSuccessAlert(data.success);
            })
            .fail((jqXHR) => {
                console.log("fail");
            })

        })
    }

</script>
</body>
</html>